<h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Éditer mon profil</h1>

<%= form_with model: @user, url: profile_path, method: :patch,
      local: true,
      class: "max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg space-y-8" do |f| %>

  <!-- IMAGE DE PROFIL -->
  <div class="flex flex-col items-center">
    <div class="w-28 h-28 mb-4 rounded-full overflow-hidden border border-gray-300 shadow">
      <img id="avatar-preview"
           src="<%= @user.image_url.presence || 'https://via.placeholder.com/96' %>"
           class="w-full h-full object-cover">
    </div>

    <%= f.text_field :image_url,
        placeholder: "URL de l’image",
        id: "avatar-input",
        value: @user.image_url,
        class: "w-full sm:w-2/3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
  </div>

  <!-- NOM + PRÉNOM -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    <div>
      <%= f.label :first_name, "Prénom", class: "block text-sm font-semibold text-gray-700" %>
      <%= f.text_field :first_name,
          value: @user.first_name,
          class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
    </div>

    <div>
      <%= f.label :last_name, "Nom", class: "block text-sm font-semibold text-gray-700" %>
      <%= f.text_field :last_name,
          value: @user.last_name,
          class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
    </div>
  </div>

  <!-- EMAIL -->
  <div>
    <%= f.label :email_address, "Adresse e-mail", class: "block text-sm font-semibold text-gray-700" %>
    <%= f.email_field :email_address,
        value: @user.email_address,
        class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
  </div>

  <!-- MOT DE PASSE -->
  <div class="bg-gray-50 p-6 rounded-lg shadow-inner space-y-4">
    <h2 class="text-lg font-bold text-gray-800">Modifier mon mot de passe</h2>

    <div>
      <%= label_tag :current_password, "Mot de passe actuel", class: "block text-sm font-medium text-gray-700" %>
      <%= password_field_tag "user[current_password]", nil,
            placeholder: "Mot de passe actuel",
            class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
    </div>

    <div>
      <%= f.label :password, "Nouveau mot de passe", class: "block text-sm font-medium text-gray-700" %>
      <%= f.password_field :password,
            placeholder: "Nouveau mot de passe",
            class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
    </div>

    <div>
      <%= f.label :password_confirmation, "Confirmation", class: "block text-sm font-medium text-gray-700" %>
      <%= f.password_field :password_confirmation,
            placeholder: "Confirmation du mot de passe",
            class: "mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-200" %>
    </div>
  </div>

  <!-- BOUTON UNIQUE -->
  <div class="flex justify-end space-x-2 pt-4 border-t">
    <%= link_to "Annuler",
        profile_path,
        class: "px-4 py-2 bg-gray-100 text-gray-700 rounded-md border hover:bg-gray-200 transition" %>

    <%= f.submit "Enregistrer",
        class: "px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition" %>
  </div>

<% end %>

<!-- SUPPRESSION DU PROFIL -->
<div class="max-w-2xl mx-auto mt-10">
  <div class="flex items-center justify-between border-t pt-4">
    <p class="text-sm text-gray-600">Supprimer votre compte est irréversible.</p>

    <button id="delete-profile-btn"
            type="button"
            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition shadow">
      Supprimer mon profil
    </button>
  </div>
</div>

<!-- MODAL -->
<div id="delete-profile-modal"
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 hidden z-50">

  <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6 space-y-4">
    <h2 class="text-xl font-bold text-red-600">Confirmer la suppression</h2>

    <p class="text-gray-700">Cette action est définitive. Voulez-vous vraiment supprimer votre compte ?</p>

    <div class="flex justify-end space-x-3 mt-4">
      <button id="cancel-delete-btn"
              class="px-4 py-2 bg-gray-100 border rounded-md hover:bg-gray-200 transition">
        Annuler
      </button>

      <%= form_with url: user_path(@user), method: :delete, local: true do %>
        <%= submit_tag "Supprimer",
            data: { confirm: "Dernière confirmation" },
            class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition shadow" %>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', () => {
  // avatar preview
  const input = document.getElementById('avatar-input')
  const preview = document.getElementById('avatar-preview')
  if (input && preview) {
    input.addEventListener('input', () => preview.src = input.value || 'https://via.placeholder.com/96')
  }

  // modal logic
  const open = document.getElementById('delete-profile-btn')
  const modal = document.getElementById('delete-profile-modal')
  const cancel = document.getElementById('cancel-delete-btn')

  if (open) open.onclick = () => modal.classList.remove('hidden')
  if (cancel) cancel.onclick = () => modal.classList.add('hidden')
  modal.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden') }
})
</script>
